@page "/game/{PartidaId:int}"

@rendermode InteractiveServer
@inject PartidasService partidasService
@inject JugadoresService jugadoresService
@inject MovimientosService movimientosService

<PageTitle>Home</PageTitle>


<div class="container mx-auto max-w-lg p-6 bg-white rounded-lg shadow-xl text-center">

    <div class="game-container">
        <h2 class="game-status">@GameStatus</h2>
        
            <div class="game-screen">
                <div class="game-board">
                    @for (var i = 0; i < 9; i++)
                    {
                        var cellIndex = i; // Copia local para evitar problemas con el closure en el lambda
                                           <button class="cell @GetPlayerClass(board[cellIndex])"
                                                   @onclick="() => HandleCellClick(cellIndex)"
                                                   disabled="@(board[cellIndex] != null || winner != null || esEmpate)">
                                               @board[cellIndex]?.ToString()
                                           </button>
                    }
                </div>

                <button class="btn btn-secondary mt-4" @onclick="RestartGame">
                    Reiniciar Juego
                </button>
            </div>
    </div>
</div>
@code {
    private enum PlayerType { X, O }

    private bool gameStarted;
    private PlayerType? playerTypeSelection;
    private PlayerType?[] board = new PlayerType?[9];
    private PlayerType _currentPlayerType = PlayerType.X;
    private PlayerType? winner;
    private bool esEmpate;
    private int? _currentPlayerId;
    private Jugadores? _currentPlayer = new Jugadores();



    [Parameter]
    public int PartidaId { get; set; }
    public Partidas Partida { get; set; } = new Partidas();
    public Movimientos Movimiento { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Partida = await partidasService.Buscar(PartidaId);
        _currentPlayerId = Partida.Jugador1Id;
        _currentPlayer = await jugadoresService.Buscar(_currentPlayerId ?? 0);
        if (Partida.EstadoTablero != "---------")
            board = Partida.EstadoTablero.Select(c => c == '-' ? (PlayerType?)null : Enum.Parse<PlayerType>(c.ToString())).ToArray();
    }

    private string GameStatus
    {
        get
        {
            if (winner != null) return $"🏆 ¡Ganador: {_currentPlayer.nombres}!";
            return esEmpate
                ? "🤝 ¡Es un empate!"
                : $"Turno de: {_currentPlayer.nombres}";
        }
    }

    private void StartGame()
    {
        if (playerTypeSelection.HasValue)
        {
            gameStarted = true;
        }
    }

    private async Task HandleCellClick(int index)
    {
        // Ignorar si la celda está ocupada o el juego terminó
        if (board[index] != null || winner != null || esEmpate)
        {
            return;
        }

        board[index] = _currentPlayerType;
        GuardarMovimientos(index);

        winner = CheckForWinner();
        ActualizarPartida();
        if (winner != null)
        {
            ActualizarJugadores();
            return; // El juego termina
        }
        esEmpate = board.All(cell => cell != null);
        if (esEmpate)
        {
            ActualizarJugadores();
            return; // El juego termina
        }
        

        // Cambiar turno
        _currentPlayerType = (_currentPlayerType == PlayerType.X)
            ? PlayerType.O
            : PlayerType.X;
        _currentPlayerId = (_currentPlayerId == Partida.Jugador1Id)
           ? Partida.Jugador2Id
           : Partida.Jugador1Id;
        _currentPlayer = await jugadoresService.Buscar(_currentPlayerId ?? 0);
    }

    public async Task GuardarMovimientos(int index)
    {
        Movimiento = new Movimientos();
        Movimiento.PartidaId = PartidaId;
        Movimiento.JugadorId = _currentPlayer.JugadorId;
        Movimiento.PosicionFila = index / 3;
        Movimiento.PosicionColumna = index % 3;

        await movimientosService.Guardar(Movimiento);
    }

    public async Task ActualizarJugadores()
    {
        Jugadores jugador1 = await jugadoresService.Buscar(Partida.Jugador1Id);
        Jugadores jugador2 = await jugadoresService.Buscar(Partida.Jugador2Id ?? 0);
        if (winner != null)
        {
            if (jugador1.JugadorId == Partida.GanadorId)
            {
                jugador1.victorias++;
                jugador2.Derrotas++;
            }
            else
            {
                jugador1.Derrotas++;
                jugador2.victorias++;
            }
        }
        else if (esEmpate)
        {
            jugador1.Empate++;
            jugador2.Empate++;
        }

        await jugadoresService.Modificar(jugador1);
        await jugadoresService.Modificar(jugador2);
    }

    private PlayerType? CheckForWinner()
    {
        var winningLines = new[]
        {
             new[] {0, 1, 2}, new[] {3, 4, 5}, new[] {6, 7, 8},// Horizontales
             new[] {0, 3, 6}, new[] {1, 4, 7}, new[] {2, 5, 8},// Verticales
             new[] {0, 4, 8}, new[] {2, 4, 6}// Diagonales
        };

        foreach (var line in winningLines)
        {
            var (a, b, c) = (line[0], line[1], line[2]);
            if (board[a].HasValue && board[a] == board[b] && board[a] == board[c])
            {
                return board[a];
            }
        }

        return null; // No hay ganador
    }

    private void RestartGame()
    {
        gameStarted = false;
        playerTypeSelection = null;
        board = new PlayerType?[9];
        _currentPlayerType = PlayerType.X;
        winner = null;
        esEmpate = false;
    }

    private string GetPlayerClass(PlayerType? player)
    {
        if (!player.HasValue) return "";
        return player == PlayerType.X ? "player-x" : "player-o";
    }

    private async Task ActualizarPartida()
    {
        Partida.EstadoTablero = string.Join("", board.Select(p => p.HasValue ? p.Value.ToString() : "-"));
        if (winner != null)
        {
            Partida.GanadorId = _currentPlayerId;
            Partida.EstadoPartida = "Finalizada";
            Partida.FechaFin = DateTime.UtcNow;
        }
        else if (esEmpate)
        {
            Partida.FechaFin = DateTime.UtcNow;
            Partida.EstadoPartida = "Empatada";
        }
        else Partida.FechaFin = null;

        
        Partida.TurnoJugadorId = (_currentPlayer.JugadorId == Partida.Jugador1Id ? Partida.Jugador2Id : Partida.Jugador1Id) ?? 0;
        await partidasService.Modificar(Partida);

    }

}